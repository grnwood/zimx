name: Build AppImage

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r zimx/requirements.txt

      - name: PyInstaller build
        run: |
          pyinstaller -y packaging/zimx.spec

      - name: Build AppImage
        run: |
          APPDIR="ZimX.AppDir"
          rm -rf "$APPDIR"
          mkdir -p "$APPDIR/usr/bin"
          mkdir -p "$APPDIR/usr/share/applications"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/256x256/apps"

          cp -r dist/ZimX/* "$APPDIR/usr/bin/"
          cp assets/icon.png "$APPDIR/usr/share/icons/hicolor/256x256/apps/zimx.png"
          cp assets/icon.png "$APPDIR/zimx.png"

          printf '%s\n' \
            '[Desktop Entry]' \
            'Type=Application' \
            'Name=ZimX' \
            'Comment=ZimX Desktop' \
            'Exec=ZimX' \
            'Icon=zimx' \
            'Terminal=false' \
            'Categories=Utility;Notes;' \
            'StartupNotify=true' \
            'StartupWMClass=ZimX' \
            > "$APPDIR/usr/share/applications/zimx.desktop"

          printf '%s\n' \
            '#!/usr/bin/env bash' \
            'set -euo pipefail' \
            'HERE="$(dirname "$(readlink -f "$0")")"' \
            'exec "$HERE/usr/bin/ZimX" "$@"' \
            > "$APPDIR/AppRun"
          chmod +x "$APPDIR/AppRun"

          curl -L -o appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          ./appimagetool "$APPDIR" "ZimX-x86_64.AppImage"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ZimX-AppImage
          path: ZimX-x86_64.AppImage
